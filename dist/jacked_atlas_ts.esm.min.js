var Q=Object.defineProperty;var X=(n,e,t)=>e in n?Q(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var h=(n,e,t)=>(X(n,typeof e!="symbol"?e+"":e,t),t);var H=n=>{let e=new FileReader;return new Promise((t,r)=>{e.onload=()=>t(e.result.split(";base64,",2)[1]),e.onerror=r,e.readAsDataURL(n)})};var $=n=>{let{x:e,y:t,width:r,height:a}=n;return r<0&&(r*=-1,e-=r),a<0&&(a*=-1,t-=a),{x:e,y:t,width:r,height:a}};var Y=()=>new Uint8Array(Uint32Array.of(1).buffer)[0]===1,ie=Y();var G=(n,e)=>{let t=[];for(let r=1;r<e.length;r+=2)t.push(n.subarray(e[r-1],e[r]));return t};var P=n=>n===void 0?!1:n.startsWith("data:image/"),V=n=>n.slice(0,n.indexOf(";base64,")+8);var W=n=>n.slice(n.indexOf(";base64,")+8),_,C,z=()=>{_=document.createElement("canvas"),C=_.getContext("2d")},q=(n,e)=>{let{width:t,height:r,x:a,y:s}=$({x:0,y:0,width:Number(n.width),height:Number(n.height),...e});return C||z(),_.width=t,_.height=r,C.clearRect(0,0,t,r),C.drawImage(n,-a,-s),C.getImageData(0,0,t,r)};var ee=!0,te="image/webp",d=new OffscreenCanvas(10,10),m=d.getContext("2d",{willReadFrequently:!0});m.imageSmoothingEnabled=!1;var k=class{rect;src_url;data_blob;constructor(e,t){this.src_url=e,this.rect={x:0,y:0,width:1,height:1,...t}}fromURL=(e,t)=>{this.src_url=e;let r=new Image;return r.src=e,r.decode().then(()=>{let{width:a,height:s}=r;t.width=a,t.height=s,d.width=a,d.height=s,m.globalCompositeOperation="copy",m.drawImage(r,0,0);let{data:y}=m.getImageData(0,0,a,s);return this.fromBuffer(y,t)}).catch(()=>{throw new Error(`failed to load url:
	${e}`)})};fromDataURI=(e,t)=>this.fromURL(e,t);fromBuffer=async(e,t)=>{t.x??=0,t.y??=0,this.rect=t,d.width=t.width,d.height=t.height,m.globalCompositeOperation="copy",m.putImageData(new ImageData(k.turnTransparent(e),t.width,t.height),0,0),this.data_blob=await d.convertToBlob({type:te}),P(this.src_url)&&(this.src_url=void 0)};clearDataBlob=()=>this.data_blob=void 0;clipImage=async e=>(this.data_blob===void 0&&await this.fromURL(this.src_url,this.rect),createImageBitmap(this.data_blob).then(t=>(d.width=this.rect.width,d.height=this.rect.height,m.globalCompositeOperation="copy",m.drawImage(t,0,0),m.globalCompositeOperation="source-in",m.drawImage(e,-this.rect.x,-this.rect.y),d)))},D=k;h(D,"turnTransparent",e=>{for(let t=0,r=e.length*4;t<r;t+=4)e[t]+e[t+1]+e[t+2]===0&&(e[t+3]=0);return new Uint8ClampedArray(e.buffer)});var re=(n,e,t,r)=>r===0?0:(255-r)/100+t*2**0+e*2**8+n*2**16,f=class{source;entries={};imgloaded;img;constructor(e){e&&this.loadImage(e)}loadImage=e=>(this.source=e,this.img=new Image,this.img.src=e,this.imgloaded=this.img.decode().then(()=>this.img).catch(()=>{throw new Error(`failed to load url:
	${e}`)}),this.imgloaded);addEntry=(e,t)=>{typeof e=="string"&&(e=JSON.parse(e));let{x:r,y:a,width:s,height:y,kind:u,data:c}=e,l=new D(u+c,{x:r,y:a,width:s,height:y});this.entries[t??Date.now()%1e9]=l};addEntries=e=>{for(let[t,r]of Object.entries(e))this.addEntry(r,parseInt(t))};getEntryImage=async e=>(await this.imgloaded,this.entries[e].clipImage(this.img));toObject=async()=>{let e={source:this.source.toString(),entries:{}};for(let[t,r]of Object.entries(this.entries)){let a,s;r.data_blob?(a="data:"+r.data_blob.type+";base64,",s=await H(r.data_blob)):P(r.src_url)?(a=V(r.src_url),s=W(r.src_url)):(a="path",s=r.src_url),e.entries[parseFloat(t)]={...r.rect,kind:a,data:s}}return e};toJSON=async()=>JSON.stringify(await this.toObject())},p=f;h(p,"fromObject",e=>{let t=new f(e.source);return t.addEntries(e.entries),t}),h(p,"fromJSON",e=>f.fromObject(JSON.parse(e))),h(p,"fromURL",e=>fetch(e).then(async t=>f.fromJSON(await t.text()))),h(p,"fromJAtlasImage",(e,t,r,a)=>f.fromJAtlasImageData(q(e),t,r,a)),h(p,"fromJAtlasImageData",(e,t,r,a)=>{r??=re;let{width:s,height:y,data:u}=e,c=u.length/(s*y),l={};console.assert(Number.isInteger(c));let[x,b]=[0,0];for(let o=0,g=u.length;o<g;o+=c)b=r(u[o+0],u[o+1],u[o+2],u[o+3]),b!==x&&(l[b]??=[],b>0&&l[b].push(o),x>0&&l[x].push(o)),x=b;l[x]?.push(u.length),delete l[0];let E=new f(t),J=[];for(let[o,g]of Object.entries(l)){let[S,v,B,U]=[s,y,0,0];for(let i=0,O=g.length;i<O;i+=2){let I=g[i]/c,A=I%s,w=I/s|0;A<S&&(S=A),w<v&&(v=w)}for(let i=1,O=g.length;i<O;i+=2){let I=g[i]/c,A=I%s,w=I/s|0;A>B&&(B=A),w>U&&(U=w)}B++,U++;let L=new D,[M,N,R,F]=[S,v,B-S,U-v],K=g.map(i=>4*(i/c%s-M+((i/(c*s)|0)-N)*R)),j=new Uint8Array(R*F*4).fill(0);for(let i of G(j,K))i.fill(255);J.push(L.fromBuffer(j,{x:M,y:N,width:R,height:F})),E.entries[parseFloat(o)]=L}return a&&Promise.all(J).then(()=>a(E)),E});var T=class{jatlas_manager;entry_id;constructor(e,t){this.jatlas_manager=e,this.entry_id=t}getImage=()=>this.jatlas_manager.getEntryImage(this.entry_id);getRect=()=>this.jatlas_manager.entries[this.entry_id].rect},Z=class{canvas;ctx;entries=[];left=0;right=0;constructor(e,t=300,r=200){this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.canvas.width=t,this.canvas.height=r,this.ctx.translate(t/2|0,0),ee&&(this.ctx.lineWidth=5,this.ctx.moveTo(0,0),this.ctx.lineTo(0,r),this.ctx.stroke(),this.ctx.scale(.25,.25)),e&&this.appendTo(e)}appendTo=e=>e.appendChild(this.canvas);addEntryLeft=async e=>{this.entries.unshift(e);let t=e instanceof T?e.getRect().width:e.width;this.left-=t;let r=this.left,a=e instanceof T?await e.getImage():e;this.ctx.drawImage(a,r,0)};addEntryRight=async e=>{this.entries.push(e);let t=e instanceof T?e.getRect().width:e.width,r=this.right;this.right+=t;let a=e instanceof T?await e.getImage():e;this.ctx.drawImage(a,r,0)}};export{D as ClipMask,T as ClippedImage,Z as HorizontalImageScroller,p as JAtlasManager};
